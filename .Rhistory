# ============================================================================
# MATCH TRANSECTS TO COVARIATES
# ============================================================================
message("\nMatching transects...")
Suitable <- read_excel("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/FRESH/processed.data/2024.results.xlsx")
library(readxl)
##############################################################################
#load packages################################################################
library(terra)
library(mgcv)
library(dplyr)
library(stringr)
library(readxl)
##############################################################################
#Import study area file#######################################################
study.area = vect("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/2025_GRTS/summer24_MCP-buffer-.5mi/summer24_MCP-buffer-.5mi.shp")
study.area = project(study.area,
"EPSG:32610")
##############################################################################
#Import models################################################################
Asotin = readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/GAM/Asotin-Full-FinalModel.RDS")
data_used <- model.frame(Asotin)
head(data_used)
##############################################################################
#Set parameters###############################################################
years = c(2024)
J = c(75:228)
s = Sys.time()
##############################################################################
#Create empty raster for prediction###########################################
message("___________________________________________________")
message("Setting up...")
#specify resolution of raster
resolution = c(30, 30)
#buffer the study area polygon
buffer = buffer(study.area, width = 2 * 1609.34)
#create empty raster
suitable.biomass = rast(ext(buffer),
res = resolution,
crs = "EPSG:32610")
#fill with placeholder values
suitable.biomass[] = 0
#as xy dataframe
extraction = as.data.frame(suitable.biomass, xy = T)
#remove layer
extraction$lyr.1 = NULL
#create prediction dataframe
prediction.df = extraction
#create SpatVector
extraction = vect(extraction,
geom = c("x", "y"),
crs = "EPSG:32610")
message(paste("Number of extraction points:", nrow(prediction.df)))
#cleanup
remove(resolution, buffer)
invisible(gc())
#Load Static Variables
static_vars <- readRDS("C:/Users/Alexis Means/Documents/Project/Raster.data/MODIS/processed/extracted_static_variables.rds")
# Recode categorical variables
static_vars <- static_vars %>%
mutate(
own = case_when(
own == 0 ~ "Public",
own == 3 ~ "Private",
own == 4 ~ "Public",
TRUE ~ as.character(own)
),
Years_Since_Fire = if_else(
is.na(Years_Since_Fire),
NA_character_,
"Post"
),
PVTGroup = case_when(
is.na(PVTGroup) ~ NA_character_,
PVTGroup == "11230_1_7_8_9"           ~ "Grassland",
PVTGroup == "11260_1_7_8_9_10_19"     ~ "Shrubland",
PVTGroup == "11540_1_7_8_9"           ~ "Riparian",
PVTGroup == "10010"                   ~ "Sparse",
PVTGroup == "10800_1_7_8_9"           ~ "Shrubland",
PVTGroup == "11250_1_7_8_9_10_19"     ~ "Shrubland",
PVTGroup == "10531_1_7_8_9"           ~ "Riparian",      # CONIFER - renamed since none of these areas were samples
PVTGroup == "10450_1_7_8_9"           ~ "Riparian",      # CONIFER - renamed since none of these areas were samples
PVTGroup == "0"                       ~ "Water/Barren",
PVTGroup == "11350_7_8_9_10_12_17_18" ~ "Grassland",
PVTGroup == "10650_1_8_9_10"          ~ "Shrubland",
PVTGroup == "11590_8_9"               ~ "Riparian",
PVTGroup == "10810_7_8_9"             ~ "Shrubland",
PVTGroup == "11240_1_7_8_9"           ~ "Shrubland",
PVTGroup == "11060_1_8_9"             ~ "Shrubland",
PVTGroup == "11390_8_9"               ~ "Grassland",
PVTGroup == "11270_7_8_9"             ~ "Shrubland",
PVTGroup == "11530_7_8_9"             ~ "Shrubland",
PVTGroup == "11420_8"                 ~ "Grassland",
TRUE ~ as.character(PVTGroup)
),
PVTGroup = as.factor(PVTGroup),
own = as.factor(own),
Years_Since_Fire = as.factor(Years_Since_Fire)
)
prediction.df <- static_vars
prediction.df <- prediction.df %>%
select(-Aspect, -CTI, -TPI, -TRI) %>%
rename(FireCat = Years_Since_Fire) %>%
mutate(DEMCub = DEM^3)
rm(static_vars)
data_dir <- "C:/Users/Alexis Means/Documents/Project/Raster.data/MODIS/processed"
daymet_dir <- "C:/Users/Alexis Means/OneDrive/OneDrive - University of Idaho/DocuMents/Project/Raster.data/Daymet/processed/2024"
MeanTemp_data<- readRDS(file.path(daymet_dir, "MeanTemp_extracted2024.rds"))
names(MeanTemp_data) <- as.character(75:228)
ndvi_data <- readRDS(file.path(data_dir, "NDVI_extracted2024.rds"))
names(ndvi_data) <- as.character(75:228)
CumPPT_data <- readRDS("C:/Users/Alexis Means/OneDrive/OneDrive - University of Idaho/DocuMents/Project/Raster.data/Daymet/processed/2024/CumulPrecip_extracted2024.rds")
names(CumPPT_data) <- as.character(75:228)
# ============================================================================
# MATCH TRANSECTS TO COVARIATES
# ============================================================================
message("\nMatching transects...")
Suitable <- read_excel("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/FRESH/processed.data/2024.results.xlsx")
Suitable <- Suitable %>% mutate(Date = as_date(Date))
##############################################################################
#load packages################################################################
library(terra)
library(dplyr)
library(tidyverse)
library(tidyverse)
##############################################################################
#Import study area file#######################################################
study.area = vect("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/2025_GRTS/summer24_MCP-buffer-.5mi/summer24_MCP-buffer-.5mi.shp")
study.area = project(study.area,
"EPSG:32610")
##############################################################################
#Import models################################################################
Asotin = readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/GAM/Asotin-Full-FinalModel.RDS")
data_used <- model.frame(Asotin)
head(data_used)
##############################################################################
#Set parameters###############################################################
years = c(2024)
J = c(75:228)
s = Sys.time()
##############################################################################
#Create empty raster for prediction###########################################
message("___________________________________________________")
message("Setting up...")
#specify resolution of raster
resolution = c(30, 30)
#buffer the study area polygon
buffer = buffer(study.area, width = 2 * 1609.34)
#create empty raster
suitable.biomass = rast(ext(buffer),
res = resolution,
crs = "EPSG:32610")
#fill with placeholder values
suitable.biomass[] = 0
#as xy dataframe
extraction = as.data.frame(suitable.biomass, xy = T)
#as xy dataframe
extraction = as.data.frame(suitable.biomass, xy = T)
#remove layer
extraction$lyr.1 = NULL
#as xy dataframe
extraction = as.data.frame(suitable.biomass, xy = T)
#remove layer
extraction$lyr.1 = NULL
#create prediction dataframe
prediction.df = extraction
#remove layer
extraction$lyr.1 = NULL
#create prediction dataframe
prediction.df = extraction
#create SpatVector
extraction = vect(extraction,
geom = c("x", "y"),
crs = "EPSG:32610")
message(paste("Number of extraction points:", nrow(prediction.df)))
#cleanup
remove(resolution, buffer)
invisible(gc())
# Recode categorical variables
static_vars <- static_vars %>%
mutate(
own = case_when(
own == 0 ~ "Public",
own == 3 ~ "Private",
own == 4 ~ "Public",
TRUE ~ as.character(own)
),
Years_Since_Fire = if_else(
is.na(Years_Since_Fire),
NA_character_,
"Post"
),
PVTGroup = case_when(
is.na(PVTGroup) ~ NA_character_,
PVTGroup == "11230_1_7_8_9"           ~ "Grassland",
PVTGroup == "11260_1_7_8_9_10_19"     ~ "Shrubland",
PVTGroup == "11540_1_7_8_9"           ~ "Riparian",
PVTGroup == "10010"                   ~ "Sparse",
PVTGroup == "10800_1_7_8_9"           ~ "Shrubland",
PVTGroup == "11250_1_7_8_9_10_19"     ~ "Shrubland",
PVTGroup == "10531_1_7_8_9"           ~ "Riparian",      # CONIFER - renamed since none of these areas were samples
PVTGroup == "10450_1_7_8_9"           ~ "Riparian",      # CONIFER - renamed since none of these areas were samples
PVTGroup == "0"                       ~ "Water/Barren",
PVTGroup == "11350_7_8_9_10_12_17_18" ~ "Grassland",
PVTGroup == "10650_1_8_9_10"          ~ "Shrubland",
PVTGroup == "11590_8_9"               ~ "Riparian",
PVTGroup == "10810_7_8_9"             ~ "Shrubland",
PVTGroup == "11240_1_7_8_9"           ~ "Shrubland",
PVTGroup == "11060_1_8_9"             ~ "Shrubland",
PVTGroup == "11390_8_9"               ~ "Grassland",
PVTGroup == "11270_7_8_9"             ~ "Shrubland",
PVTGroup == "11530_7_8_9"             ~ "Shrubland",
PVTGroup == "11420_8"                 ~ "Grassland",
TRUE ~ as.character(PVTGroup)
),
PVTGroup = as.factor(PVTGroup),
own = as.factor(own),
Years_Since_Fire = as.factor(Years_Since_Fire)
)
#Load Static Variables
static_vars <- readRDS("C:/Users/Alexis Means/Documents/Project/Raster.data/MODIS/processed/extracted_static_variables.rds")
# Recode categorical variables
static_vars <- static_vars %>%
mutate(
own = case_when(
own == 0 ~ "Public",
own == 3 ~ "Private",
own == 4 ~ "Public",
TRUE ~ as.character(own)
),
Years_Since_Fire = if_else(
is.na(Years_Since_Fire),
NA_character_,
"Post"
),
PVTGroup = case_when(
is.na(PVTGroup) ~ NA_character_,
PVTGroup == "11230_1_7_8_9"           ~ "Grassland",
PVTGroup == "11260_1_7_8_9_10_19"     ~ "Shrubland",
PVTGroup == "11540_1_7_8_9"           ~ "Riparian",
PVTGroup == "10010"                   ~ "Sparse",
PVTGroup == "10800_1_7_8_9"           ~ "Shrubland",
PVTGroup == "11250_1_7_8_9_10_19"     ~ "Shrubland",
PVTGroup == "10531_1_7_8_9"           ~ "Riparian",      # CONIFER - renamed since none of these areas were samples
PVTGroup == "10450_1_7_8_9"           ~ "Riparian",      # CONIFER - renamed since none of these areas were samples
PVTGroup == "0"                       ~ "Water/Barren",
PVTGroup == "11350_7_8_9_10_12_17_18" ~ "Grassland",
PVTGroup == "10650_1_8_9_10"          ~ "Shrubland",
PVTGroup == "11590_8_9"               ~ "Riparian",
PVTGroup == "10810_7_8_9"             ~ "Shrubland",
PVTGroup == "11240_1_7_8_9"           ~ "Shrubland",
PVTGroup == "11060_1_8_9"             ~ "Shrubland",
PVTGroup == "11390_8_9"               ~ "Grassland",
PVTGroup == "11270_7_8_9"             ~ "Shrubland",
PVTGroup == "11530_7_8_9"             ~ "Shrubland",
PVTGroup == "11420_8"                 ~ "Grassland",
TRUE ~ as.character(PVTGroup)
),
PVTGroup = as.factor(PVTGroup),
own = as.factor(own),
Years_Since_Fire = as.factor(Years_Since_Fire)
)
prediction.df <- static_vars
prediction.df <- prediction.df %>%
select(-Aspect, -CTI, -TPI, -TRI) %>%
rename(FireCat = Years_Since_Fire) %>%
mutate(DEMCub = DEM^3)
rm(static_vars)
data_dir <- "C:/Users/Alexis Means/Documents/Project/Raster.data/MODIS/processed"
daymet_dir <- "C:/Users/Alexis Means/OneDrive/OneDrive - University of Idaho/DocuMents/Project/Raster.data/Daymet/processed/2024"
MeanTemp_data<- readRDS(file.path(daymet_dir, "MeanTemp_extracted2024.rds"))
names(MeanTemp_data) <- as.character(75:228)
ndvi_data <- readRDS(file.path(data_dir, "NDVI_extracted2024.rds"))
names(ndvi_data) <- as.character(75:228)
CumPPT_data <- readRDS("C:/Users/Alexis Means/OneDrive/OneDrive - University of Idaho/DocuMents/Project/Raster.data/Daymet/processed/2024/CumulPrecip_extracted2024.rds")
names(CumPPT_data) <- as.character(75:228)
message("\nMatching transects...")
Suitable <- read_excel("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/FRESH/processed.data/2024.results.xlsx")
Suitable <- Suitable %>% mutate(Date = as_date(Date))
Suitable_sf <- Suitable %>% st_as_sf(coords = c("Long", "Lat"), crs = 4326)
library(sf)
Suitable_sf <- Suitable %>% st_as_sf(coords = c("Long", "Lat"), crs = 4326)
Suitable_utm <- st_transform(Suitable_sf, crs = 32610)
transects <- Suitable_utm %>%
mutate(
x = st_coordinates(.)[,1],
y = st_coordinates(.)[,2],
Julian_day = yday(Date)
) %>%
rename(Suitable_Biomass = SuitableBiomass)
transects_df <- st_drop_geometry(transects)
message(paste("Loaded", nrow(transects_df), "transects"))
# Add coordinates to temporal data
temporal_list <- list(
NDVI = cbind(prediction.df[, c("x", "y")], ndvi_data),
Mean_Temp = cbind(prediction.df[, c("x", "y")], MeanTemp_data),
Cummulative_Precip = cbind(prediction.df[, c("x", "y")], CumPPT_data)
)
# Add coordinates to temporal data
temporal_list <- list(
NDVI = cbind(prediction.df[, c("x", "y")], ndvi_data),
Mean_Temp = cbind(prediction.df[, c("x", "y")], MeanTemp_data),
Cummulative_Precip = cbind(prediction.df[, c("x", "y")], CumPPT_data)
)
# Matching function
get_value_at_location <- function(df, x, y, jday, tolerance = 15) {
match_idx <- which(abs(df$x - x) < tolerance & abs(df$y - y) < tolerance)
if(length(match_idx) == 0) {
distances <- sqrt((df$x - x)^2 + (df$y - y)^2)
match_idx <- which.min(distances)
if(distances[match_idx] > 60) return(NA)
} else {
match_idx <- match_idx[1]
}
col_idx <- as.character(jday)
if(col_idx %in% names(df)) return(df[match_idx, col_idx]) else return(NA)
}
# Extract temporal values
for(var_name in names(temporal_list)) {
transects_df[[var_name]] <- sapply(1:nrow(transects_df), function(i) {
get_value_at_location(temporal_list[[var_name]],
transects_df$x[i],
transects_df$y[i],
transects_df$Julian_day[i])
})
}
# Merge with static variables
model_data <- transects_df %>%
mutate(x_round = round(x/30)*30, y_round = round(y/30)*30) %>%
left_join(prediction.df %>% mutate(x_round = round(x/30)*30, y_round = round(y/30)*30),
by = c("x_round", "y_round"), suffix = c("", "_s")) %>%
select(-x_round, -y_round, -ends_with("_s"))
# Remove missing data
model_data <- model_data[complete.cases(model_data), ]
model_data <- model_data %>%
select(-Date, -TransectID, -TotalDE, -TotalDP, -AveDE, -AveDP, -PVTGroup) %>%
rename(PVTGroup = PVT) %>%
select(-Julian_day) %>%
rename(CumPPT = Cummulative_Precip) %>%
mutate(MeanTempCub = Mean_Temp^3) %>%
mutate(
PVTedit = case_when(
PVTGroup %in% c("Intermediate", "Scabland") ~ "Condensed",
TRUE ~ "Original"
),
PVTGroup = case_when(
PVTGroup %in% c("Intermediate", "Scabland") ~ "Shrubland",
TRUE ~ PVTGroup
)
)
prediction.df <- model_data %>%
select(x, y, PVTGroup, PVTedit, own, FireCat, CumPPT, HLI, NDVI, Slope, DEMCub, MeanTempCub, Suitable_Biomass) %>%
mutate(
FireCat = as.character(FireCat),
own = as.character(own),
Slope = as.numeric(Slope)
)
#predict suitable biomass####
message("Predicting Suitable Biomass...")
prediction.df$predicted.sb = round(exp(predict(Asotin, newdata = prediction.df)), 2)
prediction.df <- prediction.df %>%
mutate(sb_log = log(Suitable_Biomass))
prediction.df$predicted.sb_log = predict(Asotin, newdata = prediction.df)
#removing a point, something weird is going on with the Slope
prediction.df <- prediction.df %>%
filter(Slope != 32767)
ggplot(prediction.df, aes(x = sb_log, y = predicted.sb_log)) +
geom_point() +
geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
labs(x = "Observed (sb_log)",
y = "Predicted (predicted.sb_log)",
title = "Observed vs Predicted Values") +
theme_minimal()
#residual plot
prediction.df <- prediction.df %>%
mutate(residuals = sb_log - predicted.sb_log)
ggplot(prediction.df, aes(x = predicted.sb_log, y = residuals)) +
geom_point() +
geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
labs(x = "Predicted Values",
y = "Residuals (Observed - Predicted)",
title = "Residual Plot") +
theme_minimal()
##visualization of histogram for predicted vs measured suitable biomass
prediction.df %>%
pivot_longer(cols = c(sb_log, predicted.sb_log),
names_to = "Type",
values_to = "Value") %>%
ggplot(aes(x = Value, fill = Type)) +
geom_histogram(bins = 30, alpha = 0.6, position = "identity") +
labs(x = "Log Biomass", y = "Count", title = "Observed vs Predicted Distributions") +
theme_minimal()
View(prediction.df)
View(data_used)
##############################################################################
#Predicting Suitable Biomass, Write Rasters##################################
#predict suitable biomass####
message("Predicting Suitable Biomass...")
prediction.df$predicted.sb = round(exp(predict(Asotin, newdata = prediction.df)), 2)
prediction.df <- prediction.df %>%
mutate(sb_log = log(Suitable_Biomass))
prediction.df$predicted.sb_log = predict(Asotin, newdata = prediction.df)
prediction.df <- prediction.df %>%
select(Suitable_Biomass, predicted.sb, sb_log, predicted.sb_log, PVTedit, PVTGroup, own, FireCat, CumPPT, HLI, NDVI, Slope, DEMCub, MeanTempCub)
knitr::kable(View(prediction.df),
caption = "Sample of data used in analysis")
#removing a point, something weird is going on with the Slope
prediction.df <- prediction.df %>%
filter(Slope != 32767)
ggplot(prediction.df, aes(x = sb_log, y = predicted.sb_log)) +
geom_point() +
geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
labs(x = "Observed (sb_log)",
y = "Predicted (predicted.sb_log)",
title = "Observed vs Predicted Values") +
theme_minimal()
#residual plot
prediction.df <- prediction.df %>%
mutate(residuals = sb_log - predicted.sb_log)
ggplot(prediction.df, aes(x = predicted.sb_log, y = residuals)) +
geom_point() +
geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
labs(x = "Predicted Values",
y = "Residuals (Observed - Predicted)",
title = "Residual Plot") +
theme_minimal()
##visualization of histogram for predicted vs measured suitable biomass
prediction.df %>%
pivot_longer(cols = c(sb_log, predicted.sb_log),
names_to = "Type",
values_to = "Value") %>%
ggplot(aes(x = Value, fill = Type)) +
geom_histogram(bins = 30, alpha = 0.6, position = "identity") +
labs(x = "Suitable Biomass(Log)", y = "Count", title = "Observed vs Predicted Distributions") +
theme_minimal()
##############################################################################
#Predicting Suitable Biomass, Write Rasters##################################
#predict suitable biomass####
message("Predicting Suitable Biomass...")
prediction.df$predicted.sb = round(exp(predict(Asotin, newdata = prediction.df)), 2)
prediction.df <- prediction.df %>%
mutate(sb_log = log(Suitable_Biomass))
prediction.df$predicted.sb_log = predict(Asotin, newdata = prediction.df)
prediction.df <- prediction.df %>%
select(Suitable_Biomass, predicted.sb, sb_log, predicted.sb_log, PVTedit, PVTGroup, own, FireCat, CumPPT, HLI, NDVI, Slope, DEMCub, MeanTempCub)
library(DT)
datatable(prediction.df,
caption = "John Day Data",
options = list(pageLength = 25, scrollX = TRUE))
#removing a point, something weird is going on with the Slope
prediction.df <- prediction.df %>%
filter(Slope != 32767)
ggplot(prediction.df, aes(x = sb_log, y = predicted.sb_log)) +
geom_point() +
geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
labs(x = "Observed (sb_log)",
y = "Predicted (predicted.sb_log)",
title = "Observed vs Predicted Values") +
theme_minimal()
#residual plot
prediction.df <- prediction.df %>%
mutate(residuals = sb_log - predicted.sb_log)
ggplot(prediction.df, aes(x = predicted.sb_log, y = residuals)) +
geom_point() +
geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
labs(x = "Predicted Values",
y = "Residuals (Observed - Predicted)",
title = "Residual Plot") +
theme_minimal()
##visualization of histogram for predicted vs measured suitable biomass
prediction.df %>%
pivot_longer(cols = c(sb_log, predicted.sb_log),
names_to = "Type",
values_to = "Value") %>%
ggplot(aes(x = Value, fill = Type)) +
geom_histogram(bins = 30, alpha = 0.6, position = "identity") +
labs(x = "Suitable Biomass(Log)", y = "Count", title = "Observed vs Predicted Distributions") +
theme_minimal()
library(DT)
datatable(prediction.df,
caption = "John Day Data",
options = list(pageLength = 25, scrollX = TRUE))
summary(Asotin)
#removing a point, something weird is going on with the Slope
prediction.df <- prediction.df %>%
filter(Slope != 32767)
ggplot(prediction.df, aes(x = sb_log, y = predicted.sb_log)) +
geom_point() +
geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
labs(x = "Observed (sb_log)",
y = "Predicted (predicted.sb_log)",
title = "Observed vs Predicted Values") +
theme_minimal()
##visualization of histogram for predicted vs measured suitable biomass
prediction.df %>%
pivot_longer(cols = c(sb_log, predicted.sb_log),
names_to = "Type",
values_to = "Value") %>%
ggplot(aes(x = Value, fill = Type)) +
geom_histogram(bins = 30, alpha = 0.6, position = "identity") +
labs(x = "Suitable Biomass(Log)", y = "Count", title = "Observed vs Predicted Distributions") +
theme_minimal()
#residual plot
prediction.df <- prediction.df %>%
mutate(residuals = sb_log - predicted.sb_log)
ggplot(prediction.df, aes(x = predicted.sb_log, y = residuals)) +
geom_point() +
geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
labs(x = "Predicted Values",
y = "Residuals (Observed - Predicted)",
title = "Residual Plot") +
theme_minimal()
