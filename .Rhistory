mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"))
species_list <- unique(predictions$Spp)
for (sp in species_list) {
dat <- filter(predictions, Spp == sp)
# --- Get the matching model ---
# Check in SPP models first
model_formula <- NULL
if (sp %in% names(all_models_best$spp)) {
model_formula <- formula(all_models_best$spp[[sp]])
r2_value <- summary(all_models_best$spp[[sp]])$r.squared
} else if (sp %in% names(all_models_best$genus)) {
model_formula <- formula(all_models_best$genus[[sp]])
r2_value <- summary(all_models_best$genus[[sp]])$r.squared
} else if (sp %in% names(all_models_best$fam)) {
model_formula <- formula(all_models_best$fam[[sp]])
r2_value <- summary(all_models_best$fam[[sp]])$r.squared
} else if (sp %in% names(all_models_best$fg)) {
model_formula <- formula(all_models_best$fg[[sp]])
r2_value <- summary(all_models_best$fg[[sp]])$r.squared
}
# Convert formula to string
formula_text <- if (!is.null(model_formula)) {
paste(deparse(model_formula), collapse = " ")
} else {
"No matching model found"
}
# Append R²
if (!is.null(model_formula)) {
formula_text <- paste0(formula_text, " (R²=", round(r2_value, 3), ")")
}
# Plot 1: x = ID
p1 <- ggplot(dat, aes(x = factor(ID), y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Observation ID",
x = "Observation ID",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
legend.direction = "vertical",
axis.text.x = element_text(angle = 45, hjust = 1)
)
# Plot 2: x = Percent
p2 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Percent Cover",
x = "Percent",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
legend.direction = "vertical"
)
# Combine side-by-side
combined <- (p1 + p2) +
plot_layout(guides = "collect") &
theme(legend.position = "top", legend.direction = "vertical")
# Add species name + model formula as annotation
final_plot <- combined +
plot_annotation(
title = paste("Predicted Dry Weight for", sp),
subtitle = formula_text,  # Add the formula as a subtitle
theme = theme(
plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
plot.subtitle = element_text(size = 11, hjust = 0.5)
)
)
print(final_plot)
cat("\n\n")
}
library(patchwork)
# Create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"))
species_list <- unique(predictions$Spp)
for (sp in species_list) {
dat <- filter(predictions, Spp == sp)
# --- Get the matching model ---
# Check in SPP models first
model_formula <- NULL
if (sp %in% names(all_models_best$spp)) {
model_formula <- formula(all_models_best$spp[[sp]])
r2_value <- summary(all_models_best$spp[[sp]])$r.squared
} else if (sp %in% names(all_models_best$genus)) {
model_formula <- formula(all_models_best$genus[[sp]])
r2_value <- summary(all_models_best$genus[[sp]])$r.squared
} else if (sp %in% names(all_models_best$fam)) {
model_formula <- formula(all_models_best$fam[[sp]])
r2_value <- summary(all_models_best$fam[[sp]])$r.squared
} else if (sp %in% names(all_models_best$fg)) {
model_formula <- formula(all_models_best$fg[[sp]])
r2_value <- summary(all_models_best$fg[[sp]])$r.squared
}
# Convert formula to string
formula_text <- if (!is.null(model_formula)) {
paste(deparse(model_formula), collapse = " ")
} else {
"No matching model found"
}
# Append R²
if (!is.null(model_formula)) {
formula_text <- paste0(formula_text, " (R²=", round(r2_value, 3), ")")
}
# Plot 1: x = ID
p1 <- ggplot(dat, aes(x = factor(ID), y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Observation ID",
x = "Observation ID",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
legend.direction = "vertical",
axis.text.x = element_text(angle = 45, hjust = 1)
)
# Plot 2: x = Percent
p2 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Percent Cover",
x = "Percent",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "bottom",
legend.direction = "horizontal"
)
# Combine side-by-side
combined <- (p1 + p2) +
plot_layout(guides = "collect") &
theme(legend.position = "bottom", legend.direction = "horizontal")
# Add species name + model formula as annotation
final_plot <- combined +
plot_annotation(
title = paste("Predicted Dry Weight for", sp),
subtitle = formula_text,  # Add the formula as a subtitle
theme = theme(
plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
plot.subtitle = element_text(size = 11, hjust = 0.5)
)
)
print(final_plot)
cat("\n\n")
}
View(fg_predictions)
View(predictions)
plant_list <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/VegDatabases/Working.composition.data.xlsx"
plant <- read_excel(plant_list, "PlantList")
plant
View(plant)
plant <- plant %>%
select(Spp, Family, Genus, FG_New) %>%
rename(Code = Spp)
# Create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted")) %>% mutate(Code = str_extract(Spp, "^[^_]+"))
# Create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted")) %>% mutate(Code = str_extract(Spp, "^[^_]+")) %>%
left_join(plant, by = "Code")
plant <- read_excel(plant_list, "PlantList")
plant <- plant %>%
select(Spp, Family, Genus, FG_New) %>%
rename(Code = Spp,
FunctionalGroup = FG_New)
# Create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted")) %>% mutate(Code = str_extract(Spp, "^[^_]+")) %>%
left_join(plant, by = "Code")
#|warning: FALSE
df <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/24and25predictions.xlsx"
predictions <- read_excel(df, "Sheet1")
datatable(predictions, options = list(pageLength = 10))
# ---- Helper function to pick best model per group ----
select_best_models <- function(model_list) {
model_info <- tibble(
model_name = names(model_list),
base_name = str_remove(model_name, "\\d+$"),  # remove trailing digits
r2 = map_dbl(model_list, ~ summary(.x)$r.squared)
)
best_models <- model_info %>%
group_by(base_name) %>%
slice_max(order_by = r2, n = 1, with_ties = FALSE) %>%
ungroup()
selected <- model_list[best_models$model_name]
names(selected) <- best_models$base_name
return(selected)
}
# ---- Apply to each list ----
spp_model_best   <- select_best_models(spp_model)
fam_model_best   <- select_best_models(fam_model)
genus_model_best <- select_best_models(genus_model)
fg_model_best    <- select_best_models(fg_model)
# ---- Combine into one master list ----
all_models_best <- list(
spp   = spp_model_best,
fam   = fam_model_best,
genus = genus_model_best,
fg    = fg_model_best
)
# Function to display all model formulas and R² for a given list
print_all_models <- function(model_list, level_name) {
cat("\n==============================\n")
cat("=== ", toupper(level_name), " MODELS ===\n")
cat("==============================\n")
for (nm in names(model_list)) {
mod <- model_list[[nm]]
r2  <- summary(mod)$r.squared
cat("\n", nm, "\n")
print(formula(mod))
cat("R² =", round(r2, 3), "\n")
}
}
# Run for each level
print_all_models(spp_model_best, "species")
print_all_models(fam_model_best, "family")
print_all_models(genus_model_best, "genus")
print_all_models(fg_model_best, "functional group")
plant_list <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/VegDatabases/Working.composition.data.xlsx"
plant <- read_excel(plant_list, "PlantList")
plant <- plant %>%
select(Spp, Family, Genus, FG_New) %>%
rename(Code = Spp,
FunctionalGroup = FG_New)
# Create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted")) %>% mutate(Code = str_extract(Spp, "^[^_]+")) %>%
left_join(plant, by = "Code")
predictions <- read_excel(df, "Sheet1")
# Create color grouping
predictions <- predictions %>%
mutate(
pred_source = ifelse(pred_source == "spp_fallback", "Species", pred_source),
source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"),
Code = str_extract(Spp, "^[^_]+")
) %>%
left_join(plant, by = "Code")
predictions <- read_excel(df, "Sheet1")
# Create color grouping
predictions <- predictions %>%
mutate(
pred_source = ifelse(pred_source == "spp_fallback", "Spp", pred_source),
pred_source = ifelse(pred_source == "Species", "Spp", pred_source)
source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"),
# Create color grouping
predictions <- predictions %>%
mutate(
pred_source = ifelse(pred_source == "spp_fallback", "Spp", pred_source),
pred_source = ifelse(pred_source == "Species", "Spp", pred_source),
source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"),
Code = str_extract(Spp, "^[^_]+")
) %>%
left_join(plant, by = "Code")
head(predictions)
species_list <- unique(predictions$Spp)
for (sp in species_list) {
dat <- filter(predictions, Spp == sp)
# Identify unique pred_source values in this subset
pred_sources <- unique(dat$pred_source)
# Default: no model found
formula_text <- "No matching model found"
# Loop through pred_sources for this species
for (ps in pred_sources) {
if (ps == "Spp" & sp %in% names(all_models_best$spp)) {
model_formula <- formula(all_models_best$spp[[sp]])
r2_value <- summary(all_models_best$spp[[sp]])$r.squared
formula_text <- paste0(deparse(model_formula), " (R²=", round(r2_value, 3), ")")
} else if (ps == "Genus" & sp %in% names(all_models_best$genus)) {
model_formula <- formula(all_models_best$genus[[sp]])
r2_value <- summary(all_models_best$genus[[sp]])$r.squared
formula_text <- paste0(deparse(model_formula), " (R²=", round(r2_value, 3), ")")
} else if (ps == "Fam" & sp %in% names(all_models_best$fam)) {
model_formula <- formula(all_models_best$fam[[sp]])
r2_value <- summary(all_models_best$fam[[sp]])$r.squared
formula_text <- paste0(deparse(model_formula), " (R²=", round(r2_value, 3), ")")
} else if (ps == "FG" & sp %in% names(all_models_best$fg)) {
model_formula <- formula(all_models_best$fg[[sp]])
r2_value <- summary(all_models_best$fg[[sp]])$r.squared
formula_text <- paste0(deparse(model_formula), " (R²=", round(r2_value, 3), ")")
}
}
# Plot 1: x = ID
p1 <- ggplot(dat, aes(x = factor(ID), y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Observation ID",
x = "Observation ID",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
legend.direction = "vertical",
axis.text.x = element_text(angle = 45, hjust = 1)
)
# Plot 2: x = Percent
p2 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Percent Cover",
x = "Percent",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "bottom",
legend.direction = "horizontal"
)
# Combine side-by-side
combined <- (p1 + p2) +
plot_layout(guides = "collect") &
theme(legend.position = "bottom", legend.direction = "horizontal")
# Add species name + model formula as annotation
final_plot <- combined +
plot_annotation(
title = paste("Predicted Dry Weight for", sp),
subtitle = formula_text,
theme = theme(
plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
plot.subtitle = element_text(size = 11, hjust = 0.5)
)
)
print(final_plot)
cat("\n\n")
}
library(patchwork)
plant_list <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/VegDatabases/Working.composition.data.xlsx"
plant <- read_excel(plant_list, "PlantList")
plant <- plant %>%
select(Spp, Family, Genus, FG_New) %>%
rename(Code = Spp,
FunctionalGroup = FG_New)
# Create color grouping
predictions <- predictions %>%
mutate(
pred_source = ifelse(pred_source == "spp_fallback", "Spp", pred_source),
pred_source = ifelse(pred_source == "Species", "Spp", pred_source),
source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"),
Code = str_extract(Spp, "^[^_]+")
) %>%
left_join(plant, by = "Code")
species_list <- unique(predictions$Spp)
for (sp in species_list) {
dat <- filter(predictions, Spp == sp)
# Identify unique pred_source values in this subset
pred_sources <- unique(dat$pred_source)
# Default: no model found
formula_text <- "No matching model found"
# Loop through pred_sources for this species
for (ps in pred_sources) {
if (ps == "Spp" & sp %in% names(all_models_best$spp)) {
model_formula <- formula(all_models_best$spp[[sp]])
r2_value <- summary(all_models_best$spp[[sp]])$r.squared
formula_text <- paste0(deparse(model_formula), " (R²=", round(r2_value, 3), ")")
} else if (ps == "Genus" & sp %in% names(all_models_best$genus)) {
model_formula <- formula(all_models_best$genus[[sp]])
r2_value <- summary(all_models_best$genus[[sp]])$r.squared
formula_text <- paste0(deparse(model_formula), " (R²=", round(r2_value, 3), ")")
} else if (ps == "Fam" & sp %in% names(all_models_best$fam)) {
model_formula <- formula(all_models_best$fam[[sp]])
r2_value <- summary(all_models_best$fam[[sp]])$r.squared
formula_text <- paste0(deparse(model_formula), " (R²=", round(r2_value, 3), ")")
} else if (ps == "FG" & sp %in% names(all_models_best$fg)) {
model_formula <- formula(all_models_best$fg[[sp]])
r2_value <- summary(all_models_best$fg[[sp]])$r.squared
formula_text <- paste0(deparse(model_formula), " (R²=", round(r2_value, 3), ")")
}
}
# Plot 1: x = ID
p1 <- ggplot(dat, aes(x = factor(ID), y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Observation ID",
x = "Observation ID",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
legend.direction = "vertical",
axis.text.x = element_text(angle = 45, hjust = 1)
)
# Plot 2: x = Percent
p2 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Percent Cover",
x = "Percent",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "bottom",
legend.direction = "horizontal"
)
# Combine side-by-side
combined <- (p1 + p2) +
plot_layout(guides = "collect") &
theme(legend.position = "bottom", legend.direction = "horizontal")
# Add species name + model formula as annotation
final_plot <- combined +
plot_annotation(
title = paste("Predicted Dry Weight for", sp),
subtitle = formula_text,
theme = theme(
plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
plot.subtitle = element_text(size = 11, hjust = 0.5)
)
)
print(final_plot)
cat("\n\n")
}
#Step 1: Create a helper table with formulas for each pred_source type
get_model_text <- function(spp_name, source_type) {
if (source_type == "Spp" && spp_name %in% names(all_models_best$spp)) {
mod <- all_models_best$spp[[spp_name]]
} else if (source_type == "Genus" && spp_name %in% names(all_models_best$genus)) {
mod <- all_models_best$genus[[spp_name]]
} else if (source_type == "Fam" && spp_name %in% names(all_models_best$fam)) {
mod <- all_models_best$fam[[spp_name]]
} else if (source_type == "FG" && spp_name %in% names(all_models_best$fg)) {
mod <- all_models_best$fg[[spp_name]]
} else {
return("No model")
}
paste0(deparse(formula(mod)), " (R²=", round(summary(mod)$r.squared, 3), ")")
}
# Step 2: Add a new column to your data that contains the correct formula for that row
predictions <- predictions %>%
rowwise() %>%
mutate(model_formula_text = get_model_text(Spp, pred_source)) %>%
ungroup()
# Use rowwise safely
predictions <- predictions %>%
rowwise() %>%
mutate(model_formula_text = list(get_model_text(Spp, pred_source))) %>%
ungroup() %>%
# unlist so we have character vector again
mutate(model_formula_text = unlist(model_formula_text))
#|warning: FALSE
df <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/24and25predictions.xlsx"
predictions <- read_excel(df, "Sheet1")
plant_list <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/VegDatabases/Working.composition.data.xlsx"
plant <- read_excel(plant_list, "PlantList")
plant <- plant %>%
select(Spp, Family, Genus, FG_New) %>%
rename(Code = Spp,
FunctionalGroup = FG_New)
# Create color grouping
predictions <- predictions %>%
Code = str_extract(Spp, "^[^_]+") %>%
left_join(plant, by = "Code")
#|warning: FALSE
df <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/24and25predictions.xlsx"
predictions <- read_excel(df, "Sheet1")
plant_list <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/VegDatabases/Working.composition.data.xlsx"
plant <- read_excel(plant_list, "PlantList")
plant <- plant %>%
select(Spp, Family, Genus, FG_New) %>%
rename(Code = Spp,
FunctionalGroup = FG_New)
# Create color grouping
predictions <- predictions %>%
Code = str_extract(Spp, "^[^_]+") %>%
left_join(plant, by = "Code")
names(predictions)
names(plant)
#|warning: FALSE
df <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/24and25predictions.xlsx"
predictions <- read_excel(df, "Sheet1")
plant_list <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/VegDatabases/Working.composition.data.xlsx"
plant <- read_excel(plant_list, "PlantList")
plant <- plant %>%
select(Spp, Family, Genus, FG_New) %>%
rename(Code = Spp,
FunctionalGroup = FG_New)
# Create color grouping
predictions <- predictions %>%
mutate(Code = str_extract(Spp, "^[^_]+")) %>%
left_join(plant, by = "Code")
datatable(predictions, options = list(pageLength = 10))
