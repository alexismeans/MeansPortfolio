}
) %>%
ungroup()
# Helper to safely extract formula text from an lm
get_model_formula_text <- function(model_obj) {
if (inherits(model_obj, "lm")) {
paste(deparse(formula(model_obj)), collapse = "")
} else {
NA_character_
}
}
# Add model info to predictions
predictions <- predictions %>%
rowwise() %>%
mutate(
model_formula_text = if (source_group == "Predicted") {
src <- tolower(pred_source)  # e.g. "spp", "genus", "fam", "fg"
if (!is.null(src) && src %in% names(all_models_best)) {
taxon_col_value <- get(src)  # the taxon name in that column
if (!is.null(taxon_col_value) && taxon_col_value %in% names(all_models_best[[src]])) {
model_obj <- all_models_best[[src]][[taxon_col_value]]
get_model_formula_text(model_obj)
} else {
NA_character_
}
} else {
NA_character_
}
} else {
NA_character_
},
model_r2 = if (source_group == "Predicted") {
src <- tolower(pred_source)
if (!is.null(src) && src %in% names(all_models_best)) {
taxon_col_value <- get(src)
if (!is.null(taxon_col_value) && taxon_col_value %in% names(all_models_best[[src]])) {
model_obj <- all_models_best[[src]][[taxon_col_value]]
get_model_r2(model_obj)
} else {
NA_real_
}
} else {
NA_real_
}
} else {
NA_real_
}
) %>%
ungroup()
# Helper to safely extract formula text from an lm
get_model_formula_text <- function(model_obj) {
if (inherits(model_obj, "lm")) {
paste(deparse(formula(model_obj)), collapse = "")
} else {
NA_character_
}
}
# Helper to extract R²
get_model_r2 <- function(model_obj) {
if (inherits(model_obj, "lm")) summary(model_obj)$r.squared else NA_real_
}
# Correct version: use [[ ]] to access the taxonomic column in the current row
predictions <- predictions %>%
rowwise() %>%
mutate(
model_formula_text = if (source_group == "Predicted") {
src <- tolower(pred_source)  # e.g., "spp", "genus", "fam", "fg"
if (!is.null(src) && src %in% names(all_models_best)) {
taxon_col_value <- cur_data()[[src]]  # <-- THIS references the column in the current row
if (!is.null(taxon_col_value) && taxon_col_value %in% names(all_models_best[[src]])) {
model_obj <- all_models_best[[src]][[taxon_col_value]]
get_model_formula_text(model_obj)
} else {
NA_character_
}
} else {
NA_character_
}
} else {
NA_character_
},
model_r2 = if (source_group == "Predicted") {
src <- tolower(pred_source)
if (!is.null(src) && src %in% names(all_models_best)) {
taxon_col_value <- cur_data()[[src]]
if (!is.null(taxon_col_value) && taxon_col_value %in% names(all_models_best[[src]])) {
model_obj <- all_models_best[[src]][[taxon_col_value]]
get_model_r2(model_obj)
} else {
NA_real_
}
} else {
NA_real_
}
} else {
NA_real_
}
) %>%
ungroup()
# Helpers to safely extract formula text and R²
get_model_formula_text <- function(model_obj) {
if (inherits(model_obj, "lm")) {
paste(deparse(formula(model_obj)), collapse = "")
} else {
NA_character_
}
}
get_model_r2 <- function(model_obj) {
if (inherits(model_obj, "lm")) summary(model_obj)$r.squared else NA_real_
}
# Use pick() instead of cur_data()
predictions <- predictions %>%
rowwise() %>%
mutate(
model_formula_text = if (source_group == "Predicted") {
src <- tolower(pred_source)  # e.g., "spp", "genus", "fam", "fg"
if (!is.null(src) && src %in% names(all_models_best)) {
taxon_col_value <- pick(all_of(src))[[1]]  # <- updated: pick() safely selects column
if (!is.null(taxon_col_value) && taxon_col_value %in% names(all_models_best[[src]])) {
model_obj <- all_models_best[[src]][[taxon_col_value]]
get_model_formula_text(model_obj)
} else NA_character_
} else NA_character_
} else NA_character_,
model_r2 = if (source_group == "Predicted") {
src <- tolower(pred_source)
if (!is.null(src) && src %in% names(all_models_best)) {
taxon_col_value <- pick(all_of(src))[[1]]
if (!is.null(taxon_col_value) && taxon_col_value %in% names(all_models_best[[src]])) {
model_obj <- all_models_best[[src]][[taxon_col_value]]
get_model_r2(model_obj)
} else NA_real_
} else NA_real_
} else NA_real_
) %>%
ungroup()
#|warning: FALSE
df <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/24and25predictions.xlsx"
predictions <- read_excel(df, "Sheet1")
datatable(predictions, options = list(pageLength = 10))
View(predictions)
head(predictions)
library(patchwork)  # for combining plots side by side
# Function to create plots for one species
plot_species_predictions <- function(species_name, predictions, save_plots = FALSE) {
# Filter for this species
dat <- predictions %>% filter(Spp == species_name)
# Prepare annotation text
# For predicted rows, pick unique formula and R2
formula_text <- unique(dat$Formula[dat$source_group == "Predicted"])
r2_text <- unique(dat$R2[dat$source_group == "Predicted"])
annotation_text <- if (length(formula_text) > 0) {
glue("{formula_text}\nR² = {r2_text}")
} else {
""  # leave empty if no model
}
# Base theme
base_theme <- theme_bw(base_size = 12) +
theme(
legend.position = "top",
legend.title = element_blank(),
plot.subtitle = element_text(size = 10, face = "italic")
)
# Plot 1: pred_DryWeight vs Percent
p1 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
labs(
title = glue("{species_name} — Predicted Dry Weight"),
subtitle = annotation_text,
x = "Percent",
y = "Predicted Dry Weight (g)"
) +
base_theme
# Plot 2: pred_DryWeight vs ID
p2 <- ggplot(dat, aes(x = ID, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
labs(
x = "ID",
y = "Predicted Dry Weight (g)"
) +
base_theme
# Combine plots side by side
combined_plot <- p1 + p2 + plot_layout(guides = "collect")
# Save or display
if (save_plots) {
ggsave(glue("plots/{species_name}_pred_plot.png"), combined_plot, width = 10, height = 5, dpi = 300)
} else {
print(combined_plot)
}
}
walk(species_list, ~plot_species_predictions(.x, predictions))
spp_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Species-Top-Model-List.rds")
fam_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Family-Top-Model-List.rds")
genus_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Genus-Top-Model-List.rds")
fg_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Functional-Group-Top-Model-List.rds")
all_models <- list(
spp   = spp_model,
fam   = fam_model,
genus = genus_model,
fg    = fg_model
)
#|warning: False
#|message: false
library(patchwork)  # for combining plots side by side
# Function to create plots for one species
plot_species_predictions <- function(species_name, predictions, save_plots = FALSE) {
# Filter for this species
dat <- predictions %>% filter(Spp == species_name)
# Prepare annotation text
# For predicted rows, pick unique formula and R2
formula_text <- unique(dat$Formula[dat$source_group == "Predicted"])
r2_text <- unique(dat$R2[dat$source_group == "Predicted"])
annotation_text <- if (length(formula_text) > 0) {
glue("{formula_text}\nR² = {r2_text}")
} else {
""  # leave empty if no model
}
# Base theme
base_theme <- theme_bw(base_size = 12) +
theme(
legend.position = "top",
legend.title = element_blank(),
plot.subtitle = element_text(size = 10, face = "italic")
)
# Plot 1: pred_DryWeight vs Percent
p1 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
labs(
title = glue("{species_name} — Predicted Dry Weight"),
subtitle = annotation_text,
x = "Percent",
y = "Predicted Dry Weight (g)"
) +
base_theme
# Plot 2: pred_DryWeight vs ID
p2 <- ggplot(dat, aes(x = ID, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
labs(
x = "ID",
y = "Predicted Dry Weight (g)"
) +
base_theme
# Combine plots side by side
combined_plot <- p1 + p2 + plot_layout(guides = "collect")
# Save or display
if (save_plots) {
ggsave(glue("plots/{species_name}_pred_plot.png"), combined_plot, width = 10, height = 5, dpi = 300)
} else {
print(combined_plot)
}
}
# Run for all species
species_list <- unique(predictions$Spp)
spp_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Species-Top-Model-List.rds")
fam_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Family-Top-Model-List.rds")
genus_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Genus-Top-Model-List.rds")
fg_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Functional-Group-Top-Model-List.rds")
all_models <- list(
spp   = spp_model,
fam   = fam_model,
genus = genus_model,
fg    = fg_model
)
#| warning: FALSE
library(tidyverse)
library(readr)
library(readxl)
library(DT)
spp <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/spp_models_diagnostics.xlsx"
spp_predictions <- read_excel(spp, "Sheet1")
datatable(spp_predictions, options = list(pageLength = 10))
#| warning: FALSE
library(tidyverse)
library(readr)
library(readxl)
library(DT)
spp <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/spp_models_diagnostics.xlsx"
spp_predictions <- read_excel(spp, "Sheet1")
datatable(spp_predictions, options = list(pageLength = 10))
genus <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/genus_models_diagnostics.xlsx"
genus_predictions <- read_excel(genus, "Sheet1")
datatable(genus_predictions, options = list(pageLength = 10))
fam <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/family_models_diagnostics.xlsx"
fam_predictions <- read_excel(fam, "Sheet1")
datatable(fam_predictions, options = list(pageLength = 10))
fg <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/fg_models_diagnostics.xlsx"
datatable(fg_predictions, options = list(pageLength = 10))
fg <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/fg_models_diagnostics.xlsx"
fg_predictions <- read_excel(fg, "Sheet1")
datatable(fg_predictions, options = list(pageLength = 10))
#|warning: FALSE
df <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/24and25predictions.xlsx"
predictions <- read_excel(df, "Sheet1")
View(predictions)
pred <- predictions %>%
select(ID, Spp, pred_DryWeight, Percent, pred_source)
datatable(pred, options = list(pageLength = 10))
# ---- Helper function to pick best model per group ----
select_best_models <- function(model_list) {
model_info <- tibble(
model_name = names(model_list),
base_name = str_remove(model_name, "\\d+$"),  # remove trailing digits
r2 = map_dbl(model_list, ~ summary(.x)$r.squared)
)
best_models <- model_info %>%
group_by(base_name) %>%
slice_max(order_by = r2, n = 1, with_ties = FALSE) %>%
ungroup()
selected <- model_list[best_models$model_name]
names(selected) <- best_models$base_name
return(selected)
}
# ---- Apply to each list ----
spp_model_best   <- select_best_models(spp_model)
fam_model_best   <- select_best_models(fam_model)
fg_model_best    <- select_best_models(fg_model)
# ---- Combine into one master list ----
all_models_best <- list(
spp   = spp_model_best,
fam   = fam_model_best,
genus = genus_model_best,
fg    = fg_model_best
)
genus_model_best <- select_best_models(genus_model)
fg_model_best    <- select_best_models(fg_model)
# ---- Combine into one master list ----
all_models_best <- list(
spp   = spp_model_best,
fam   = fam_model_best,
genus = genus_model_best,
fg    = fg_model_best
)
# Function to display all model formulas and R² for a given list
print_all_models <- function(model_list, level_name) {
cat("\n==============================\n")
cat("=== ", toupper(level_name), " MODELS ===\n")
cat("==============================\n")
for (nm in names(model_list)) {
mod <- model_list[[nm]]
r2  <- summary(mod)$r.squared
cat("\n", nm, "\n")
print(formula(mod))
cat("R² =", round(r2, 3), "\n")
}
}
# Run for each level
print_all_models(spp_model_best, "species")
print_all_models(fam_model_best, "family")
print_all_models(genus_model_best, "genus")
print_all_models(fg_model_best, "functional group")
#|warning: False
#|message: false
library(patchwork)  # for combining plots side by side
# Function to create plots for one species
plot_species_predictions <- function(species_name, predictions, save_plots = FALSE) {
# Filter for this species
dat <- predictions %>% filter(Spp == species_name)
# Prepare annotation text
# For predicted rows, pick unique formula and R2
formula_text <- unique(dat$Formula[dat$source_group == "Predicted"])
r2_text <- unique(dat$R2[dat$source_group == "Predicted"])
annotation_text <- if (length(formula_text) > 0) {
glue("{formula_text}\nR² = {r2_text}")
} else {
""  # leave empty if no model
}
# Base theme
base_theme <- theme_bw(base_size = 12) +
theme(
legend.position = "top",
legend.title = element_blank(),
plot.subtitle = element_text(size = 10, face = "italic")
)
# Plot 1: pred_DryWeight vs Percent
p1 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
labs(
title = glue("{species_name} — Predicted Dry Weight"),
subtitle = annotation_text,
x = "Percent",
y = "Predicted Dry Weight (g)"
) +
base_theme
# Plot 2: pred_DryWeight vs ID
p2 <- ggplot(dat, aes(x = ID, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
labs(
x = "ID",
y = "Predicted Dry Weight (g)"
) +
base_theme
# Combine plots side by side
combined_plot <- p1 + p2 + plot_layout(guides = "collect")
# Save or display
if (save_plots) {
ggsave(glue("plots/{species_name}_pred_plot.png"), combined_plot, width = 10, height = 5, dpi = 300)
} else {
print(combined_plot)
}
}
# Run for all species
species_list <- unique(predictions$Spp)
walk(species_list, ~plot_species_predictions(.x, predictions))
# Function to create plots for one species
plot_species_predictions <- function(species_name, predictions, save_plots = FALSE) {
# Filter for this species
dat <- predictions %>% filter(Spp == species_name)
# Prepare annotation text
# For predicted rows, pick unique pred_source, formula, and R2
formula_text <- unique(dat$Formula[dat$source_group == "Predicted"])
r2_text <- unique(dat$R2[dat$source_group == "Predicted"])
pred_source_text <- unique(dat$pred_source[dat$source_group == "Predicted"])
annotation_text <- if (length(formula_text) > 0) {
glue("Source: {pred_source_text}\n{formula_text}\nR² = {r2_text}")
} else {
""  # leave empty if no model
}
# Base theme with legend at bottom and horizontal
base_theme <- theme_bw(base_size = 12) +
theme(
legend.position = "bottom",
legend.direction = "horizontal",
legend.title = element_blank(),
plot.subtitle = element_text(size = 10, face = "italic")
)
# Plot 1: pred_DryWeight vs Percent
p1 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
labs(
title = glue("{species_name} — Predicted Dry Weight"),
subtitle = annotation_text,
x = "Percent",
y = "Predicted Dry Weight (g)"
) +
base_theme
# Plot 2: pred_DryWeight vs ID
p2 <- ggplot(dat, aes(x = ID, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
labs(
x = "ID",
y = "Predicted Dry Weight (g)"
) +
base_theme
# Combine plots side by side
combined_plot <- p1 + p2 + plot_layout(guides = "collect")
# Save or display
if (save_plots) {
ggsave(glue("plots/{species_name}_pred_plot.png"), combined_plot, width = 10, height = 5, dpi = 300)
} else {
print(combined_plot)
}
}
# Run for all species
species_list <- unique(predictions$Spp)
walk(species_list, ~plot_species_predictions(.x, predictions))
#|warning: False
#|Message: False
library(ggplot2)
library(dplyr)
library(purrr)
library(glue)
library(patchwork)  # for combining plots side by side
plot_species_predictions <- function(species_name, predictions, save_plots = FALSE) {
# Filter for this species
dat <- predictions %>% filter(Spp == species_name)
# Prepare annotation text
formula_text <- unique(dat$Formula[dat$source_group == "Predicted"])
r2_text <- unique(dat$R2[dat$source_group == "Predicted"])
pred_source_text <- unique(dat$pred_source[dat$source_group == "Predicted"])
annotation_text <- if (length(formula_text) > 0) {
glue("Source: {pred_source_text}\n{formula_text}\nR² = {r2_text}")
} else {
""
}
# Base theme
base_theme <- theme_bw(base_size = 12) +
theme(
legend.title = element_blank(),
plot.subtitle = element_text(size = 10, face = "italic")
)
# Plot 1: pred_DryWeight vs Percent
p1 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
labs(
title = glue("{species_name} — Predicted Dry Weight"),
subtitle = annotation_text,
x = "Percent Cover",
y = "Predicted Dry Weight (g)"
) +
base_theme
# Plot 2: pred_DryWeight vs ID
p2 <- ggplot(dat, aes(x = ID, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
labs(
x = "Observation ID",
y = "Predicted Dry Weight (g)"
) +
base_theme
# Combine plots side by side with legend at bottom
combined_plot <- p1 + p2 +
plot_layout(guides = "collect") &
theme(legend.position = "bottom", legend.direction = "horizontal")
# Save or display
if (save_plots) {
ggsave(glue("plots/{species_name}_pred_plot.png"), combined_plot, width = 10, height = 5, dpi = 300)
} else {
print(combined_plot)
}
}
# Run for all species
species_list <- unique(predictions$Spp)
walk(species_list, ~plot_species_predictions(.x, predictions))
