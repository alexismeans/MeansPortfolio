genus = genus_model,
fg    = fg_model
)
#| warning: FALSE
library(readr)
library(readxl)
library(DT)
df <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/24and25predictions.xlsx"
predictions <- read_excel(df, "Sheet1")
datatable(predictions, options = list(pageLength = 10))
spp <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/spp_models_diagnostics.xlsx"
spp_predictions <- read_excel(spp, "Sheet1")
datatable(spp_predictions, options = list(pageLength = 10))
genus <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/genus_models_diagnostics.xlsx"
genus_predictions <- read_excel(genus, "Sheet1")
datatable(genus_predictions, options = list(pageLength = 10))
fam <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/family_models_diagnostics.xlsx"
fam_predictions <- read_excel(fam, "Sheet1")
datatable(fam_predictions, options = list(pageLength = 10))
fg <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/fg_models_diagnostics.xlsx"
fg_predictions <- read_excel(fg, "Sheet1")
datatable(fg_predictions, options = list(pageLength = 10))
#| warning: FALSE
library(tidyverse)
library(lmtest)
library(purrr)
library(DT)
check_lm_assumptions <- function(model) {
if (!inherits(model, "lm")) return(NULL)
res <- residuals(model)
list(
r_squared = tryCatch(round(summary(model)$r.squared, 4), error = function(e) NA),
shapiro_p = tryCatch(round(shapiro.test(res)$p.value, 4), error = function(e) NA),
bp_test   = tryCatch(round(lmtest::bptest(model)$p.value, 4), error = function(e) NA),
dw_test   = tryCatch(round(lmtest::dwtest(model)$p.value, 4), error = function(e) NA),
cook_max  = tryCatch(round(max(cooks.distance(model), na.rm = TRUE), 4), error = function(e) NA)
)
}
diagnostics <- imap_dfr(all_models, function(model_list, group_name) {
map_dfr(model_list, check_lm_assumptions, .id = "model_name") %>%
mutate(group = group_name, .before = 1)
})
#--------------------------------------------------------------
# 3️⃣ Extract model base name (everything before trailing number)
#     Example: "BRTE_GREEN1" → "BRTE_GREEN"
#--------------------------------------------------------------
diagnostics <- diagnostics %>%
mutate(model_base = str_trim(str_extract(model_name, ".*(?=\\d+$)")))
#--------------------------------------------------------------
# 4️⃣ Identify and remove model families with any R² > 0.4
#--------------------------------------------------------------
high_r2_bases <- diagnostics %>%
group_by(model_base) %>%
summarize(any_high_r2 = any(r_squared > 0.4, na.rm = TRUE)) %>%
filter(any_high_r2) %>%
pull(model_base)
diagnostics_low_r2 <- diagnostics %>%
filter(!model_base %in% high_r2_bases)
datatable(diagnostics_low_r2, options = list(pageLength = 10))
#| warning: FALSE
library(ggfortify)
library(gridExtra)
plot_diagnostics <- function(model, model_name, group_name) {
p1 <- autoplot(model, which = 1)[[1]] +
ggtitle(paste("Residuals vs Fitted for", model_name, "in", group_name))
p2 <- autoplot(model, which = 2)[[1]] +
ggtitle(paste("Normal Q-Q for", model_name, "in", group_name))
p3 <- autoplot(model, which = 3)[[1]] +
ggtitle(paste("Scale-Location for", model_name, "in", group_name))
p4 <- autoplot(model, which = 5)[[1]] +
ggtitle(paste("Residuals vs Leverage for", model_name, "in", group_name))
gridExtra::grid.arrange(p1, p2, p3, p4, ncol = 2)
}
imap(all_models, function(model_list, group_name) {
# Filter only models from this group that passed the R² criteria
keep_models <- diagnostics_low_r2 %>%
filter(group == group_name) %>%
pull(model_name)
# Subset model list to those models
model_list_filtered <- model_list[names(model_list) %in% keep_models]
# Plot only the retained models
walk2(model_list_filtered, names(model_list_filtered), ~ {
plot_diagnostics(.x, .y, group_name)
})
})
spp_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Species-Top-Model-List.rds")
fam_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Family-Top-Model-List.rds")
genus_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Genus-Top-Model-List.rds")
fg_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Functional-Group-Top-Model-List.rds")
all_models <- list(
spp   = spp_model,
fam   = fam_model,
genus = genus_model,
fg    = fg_model
)
#| warning: FALSE
library(readr)
library(readxl)
library(DT)
df <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/24and25predictions.xlsx"
predictions <- read_excel(df, "Sheet1")
datatable(predictions, options = list(pageLength = 10))
spp <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/spp_models_diagnostics.xlsx"
spp_predictions <- read_excel(spp, "Sheet1")
datatable(spp_predictions, options = list(pageLength = 10))
genus <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/genus_models_diagnostics.xlsx"
genus_predictions <- read_excel(genus, "Sheet1")
datatable(genus_predictions, options = list(pageLength = 10))
fam <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/family_models_diagnostics.xlsx"
fam_predictions <- read_excel(fam, "Sheet1")
datatable(fam_predictions, options = list(pageLength = 10))
fam <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/family_models_diagnostics.xlsx"
fam_predictions <- read_excel(fam, "Sheet1")
datatable(fam_predictions, options = list(pageLength = 10))
fg <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/fg_models_diagnostics.xlsx"
fg_predictions <- read_excel(fg, "Sheet1")
datatable(fg_predictions, options = list(pageLength = 10))
#| warning: FALSE
library(tidyverse)
library(lmtest)
library(purrr)
library(DT)
check_lm_assumptions <- function(model) {
if (!inherits(model, "lm")) return(NULL)
res <- residuals(model)
list(
r_squared = tryCatch(round(summary(model)$r.squared, 4), error = function(e) NA),
shapiro_p = tryCatch(round(shapiro.test(res)$p.value, 4), error = function(e) NA),
bp_test   = tryCatch(round(lmtest::bptest(model)$p.value, 4), error = function(e) NA),
dw_test   = tryCatch(round(lmtest::dwtest(model)$p.value, 4), error = function(e) NA),
cook_max  = tryCatch(round(max(cooks.distance(model), na.rm = TRUE), 4), error = function(e) NA)
)
}
diagnostics <- imap_dfr(all_models, function(model_list, group_name) {
map_dfr(model_list, check_lm_assumptions, .id = "model_name") %>%
mutate(group = group_name, .before = 1)
})
#--------------------------------------------------------------
# 3️⃣ Extract model base name (everything before trailing number)
#     Example: "BRTE_GREEN1" → "BRTE_GREEN"
#--------------------------------------------------------------
diagnostics <- diagnostics %>%
mutate(model_base = str_trim(str_extract(model_name, ".*(?=\\d+$)")))
#--------------------------------------------------------------
# 4️⃣ Identify and remove model families with any R² > 0.4
#--------------------------------------------------------------
high_r2_bases <- diagnostics %>%
group_by(model_base) %>%
summarize(any_high_r2 = any(r_squared > 0.4, na.rm = TRUE)) %>%
filter(any_high_r2) %>%
pull(model_base)
diagnostics_low_r2 <- diagnostics %>%
filter(!model_base %in% high_r2_bases)
datatable(diagnostics_low_r2, options = list(pageLength = 10))
#| warning: FALSE
#| eval: FALSE
library(ggfortify)
library(gridExtra)
plot_diagnostics <- function(model, model_name, group_name) {
p1 <- autoplot(model, which = 1)[[1]] +
ggtitle(paste("Residuals vs Fitted for", model_name, "in", group_name))
p2 <- autoplot(model, which = 2)[[1]] +
ggtitle(paste("Normal Q-Q for", model_name, "in", group_name))
p3 <- autoplot(model, which = 3)[[1]] +
ggtitle(paste("Scale-Location for", model_name, "in", group_name))
p4 <- autoplot(model, which = 5)[[1]] +
ggtitle(paste("Residuals vs Leverage for", model_name, "in", group_name))
gridExtra::grid.arrange(p1, p2, p3, p4, ncol = 2)
}
imap(all_models, function(model_list, group_name) {
# Filter only models from this group that passed the R² criteria
keep_models <- diagnostics_low_r2 %>%
filter(group == group_name) %>%
pull(model_name)
# Subset model list to those models
model_list_filtered <- model_list[names(model_list) %in% keep_models]
# Plot only the retained models
walk2(model_list_filtered, names(model_list_filtered), ~ {
plot_diagnostics(.x, .y, group_name)
})
})
#create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"))
View(predictions)
# get unique species list
species_list <- unique(predictions$Spp)
# loop through species and print each plot inline
for (sp in species_list) {
dat <- filter(predictions, Spp == sp)
p <- ggplot(dat, aes(x = DryWeight, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = paste("Observed vs Predicted Dry Weight –", sp),
x = "Observed Dry Weight (g)",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 12),
legend.position = "top"
)
print(p)
}
#| message: false
#| warning: false
#| fig.height: 4
#| fig.width: 6
#| fig.align: center
# Create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"))
# Get unique species list
species_list <- unique(predictions$Spp)
# Loop through species and print each plot inline
for (sp in species_list) {
dat <- filter(predictions, Spp == sp)
# Add section header for clarity
cat("###", sp, "\n\n")
p <- ggplot(dat, aes(x = factor(ID), y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = paste("Predicted Dry Weight by Observation –", sp),
x = "Observation ID",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 12),
legend.position = "top",
axis.text.x = element_text(angle = 45, hjust = 1)
)
print(p)
cat("\n\n")  # spacing between plots
}
{r}
#| message: false
#| warning: false
#| fig.height: 4
#| fig.width: 6
#| fig.align: center
# Create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"))
# Get unique species list
species_list <- unique(predictions$Spp)
# Loop through species and print each plot inline
for (sp in species_list) {
dat <- filter(predictions, Spp == sp)
# Add section header for clarity
cat("###", sp, "\n\n")
p <- ggplot(dat, aes(x = factor(Percent), y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = paste("Predicted Dry Weight by Observation –", sp),
x = "Percent",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 12),
legend.position = "top",
axis.text.x = element_text(angle = 45, hjust = 1)
)
print(p)
cat("\n\n")  # spacing between plots
}
#| message: false
#| warning: false
#| fig.height: 4
#| fig.width: 10
#| fig.align: center
library(patchwork)  # <-- important for combining plots
install.packages("patchwork")
#| message: false
#| warning: false
#| fig.height: 4
#| fig.width: 10
#| fig.align: center
library(patchwork)  # <-- important for combining plots
# Create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"))
# Get unique species list
species_list <- unique(predictions$Spp)
# Loop through species and print each set of two plots side-by-side
for (sp in species_list) {
dat <- filter(predictions, Spp == sp)
# Header for each species
cat("###", sp, "\n\n")
# Plot 1: x = ID
p1 <- ggplot(dat, aes(x = factor(ID), y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Observation ID",
x = "Observation ID",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
axis.text.x = element_text(angle = 45, hjust = 1)
)
# Plot 2: x = Percent
p2 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Percent Cover",
x = "Percent",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top"
)
# Combine plots side-by-side
combined <- p1 + p2 + plot_layout(guides = "collect")
print(combined)
cat("\n\n")  # spacing between species
}
#| message: false
#| warning: false
#| fig.height: 4
#| fig.width: 10
#| fig.align: center
library(patchwork)  # <-- important for combining plots
# Create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"))
# Get unique species list
species_list <- unique(predictions$Spp)
# Loop through species and print each combined plot
for (sp in species_list) {
dat <- filter(predictions, Spp == sp)
# Header
cat("###", sp, "\n\n")
# Plot 1: x = ID
p1 <- ggplot(dat, aes(x = factor(ID), y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Observation ID",
x = "Observation ID",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
legend.direction = "vertical",   # ← stack legend items vertically
axis.text.x = element_text(angle = 45, hjust = 1)
)
# Plot 2: x = Percent
p2 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Percent Cover",
x = "Percent",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
legend.direction = "vertical"   # ← stack legend items vertically
)
# Combine side-by-side with a shared, vertical legend
combined <- p1 + p2 +
plot_layout(guides = "collect") &
theme(legend.position = "top", legend.direction = "vertical")
print(combined)
cat("\n\n")
}
#| message: false
#| warning: false
#| fig.height: 4
#| fig.width: 10
#| fig.align: center
library(patchwork)  # <-- important for combining plots
# Create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"))
# Get unique species list
species_list <- unique(predictions$Spp)
# Loop through species and print each combined plot
for (sp in species_list) {
dat <- filter(predictions, Spp == sp)
# Plot 1: x = ID
p1 <- ggplot(dat, aes(x = factor(ID), y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Observation ID",
x = "Observation ID",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
legend.direction = "vertical",
axis.text.x = element_text(angle = 45, hjust = 1)
)
# Plot 2: x = Percent
p2 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Percent Cover",
x = "Percent",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
legend.direction = "vertical"
)
# Combine side-by-side and share legend vertically above both plots
combined <- (p1 + p2) +
plot_layout(guides = "collect") &
theme(legend.position = "top", legend.direction = "vertical")
# Add species name as a single annotation above everything
final_plot <- combined +
plot_annotation(
title = paste("Predicted Dry Weight for", sp),
theme = theme(
plot.title = element_text(size = 14, face = "bold", hjust = 0.5)
)
)
print(final_plot)
cat("\n\n")
}
#| message: false
#| warning: false
#| fig.height: 4
#| fig.width: 10
#| fig.align: center
library(patchwork)  # <-- important for combining plots
# Create color grouping
predictions <- predictions %>%
mutate(source_group = ifelse(pred_source == "Observed", "Observed", "Predicted"))
# Get unique species list
species_list <- unique(predictions$Spp)
# Loop through species and print each combined plot
for (sp in species_list) {
dat <- filter(predictions, Spp == sp)
# Plot 1: x = ID
p1 <- ggplot(dat, aes(x = factor(ID), y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Observation ID",
x = "Observation ID",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
legend.direction = "vertical",
axis.text.x = element_text(angle = 45, hjust = 1)
)
# Plot 2: x = Percent
p2 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
geom_point(size = 2, alpha = 0.8) +
scale_color_manual(values = c("Observed" = "steelblue", "Predicted" = "orange")) +
labs(
title = "By Percent Cover",
x = "Percent",
y = "Predicted Dry Weight (g)",
color = "Data Source"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", size = 11),
legend.position = "top",
legend.direction = "vertical"
)
# Combine side-by-side and share legend vertically above both plots
combined <- (p1 + p2) +
plot_layout(guides = "collect") &
theme(legend.position = "top", legend.direction = "vertical")
# Add species name as a single annotation above everything
final_plot <- combined +
plot_annotation(
title = paste("Predicted Dry Weight for", sp),
theme = theme(
plot.title = element_text(size = 14, face = "bold", hjust = 0.5)
)
)
print(final_plot)
cat("\n\n")
}
