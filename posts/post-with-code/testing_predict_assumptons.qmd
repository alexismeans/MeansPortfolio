---
title: "Checking Biomass Predictions"
author: "Alexis Means"
date: "2025-10-2"
description: This document contains assumption tests and plots to analyze my linear regression equations for biomass predictions. 
format:
  html:
    toc: true
    toc-location: left
    toc-depth: 3
editor: visual
code-fold: true
execute: 
  warning: false
  message: false
---

```{r}
spp_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Species-Top-Model-List.rds")

fam_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Family-Top-Model-List.rds")

genus_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Genus-Top-Model-List.rds")

fg_model <- readRDS("C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/regression_equations/24and25-Biomass-Regression-Functional-Group-Top-Model-List.rds")

all_models <- list(
  spp   = spp_model,
  fam   = fam_model,
  genus = genus_model,
  fg    = fg_model
)

```

## Predicted Biomass

This data frame includes all the predicted biomass measurements in a table if you are curious to look at them. All of this data should be reflected below in the graphs though.

```{r}
#| warning: FALSE
library(tidyverse)
library(readr)
library(readxl)
library(DT)
library(openxlsx)

spp <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/spp_models_diagnostics.xlsx"
genus <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/genus_models_diagnostics.xlsx"
fam <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/family_models_diagnostics.xlsx"
fg <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/PS_update_fg_models_diagnostics.xlsx"
df <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/24and25predictions.xlsx"

sp_eq <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/spp_models_equations.xlsx"
ge_eq <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/genus_models_equations.xlsx"
fa_eq <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/family_models_equations.xlsx"
fg_eq <- "C:/Users/Alexis Means/Documents/Project/Nutrition Sampling/R code/biomass/processed.data/fg_models_equations.xlsx"

spp_equations <- read_excel(sp_eq, "Sheet1")
genus_equations <- read_excel(ge_eq, "Sheet1")
fam_equations <- read_excel(fa_eq, "Sheet1")
fg_equations <- read_excel(fg_eq, "Sheet1")

spp_predictions <- read_excel(spp, "Sheet1")
genus_predictions <- read_excel(genus, "Sheet1")
fam_predictions <- read_excel(fam, "Sheet1")
fg_predictions <- read_excel(fg, "Sheet1")
predictions <- read_excel(df, "Sheet1")

pred <- predictions %>% 
  select(ID, Spp, pred_DryWeight, Percent, pred_source)

#left join this to covariate dbs
used_equations <- predictions %>% 
  distinct(R2,.keep_all = TRUE) %>% 
  filter(!if_any(everything(), ~ grepl("observed", .x, ignore.case = TRUE))) %>% 
  select(-DryWeight, -pred_DryWeight, -Percent, -source_group, -ID, -PlotID)

se <- spp_equations %>% 
  select(R2, AIC, formula)
ge <- genus_equations %>% 
  select(R2, AIC, formula)
fame <- fam_equations %>% 
  select(R2, AIC, formula)
fge <- fg_equations %>% 
  select(R2, AIC, formula)
eq_lookup <- bind_rows(se, ge, fame, fge)

used_equations <- used_equations %>% 
  left_join(eq_lookup, by = "R2") %>% 
  distinct(R2,.keep_all = TRUE) 

eq <- used_equations %>% 
  select(R2, formula)
predictions <- predictions %>% 
  left_join(eq, by = "R2") %>% 
  rename(Formula = formula)

datatable(
  pred,
  options = list(
    pageLength = 20,        # show more rows per page
    scrollX = TRUE,         # horizontal scrolling for wide tables
    scrollY = "400px",      # limit vertical size
    dom = "tip",            # minimal controls (t = table, i = info, p = pagination)
    columnDefs = list(
      list(className = 'dt-center', targets = "_all")  # center-align
    )
  ),
  class = "compact stripe hover",
  caption = "Predicted Biomass"
)

```

```{r}
#| warning: FALSE

#left join this to covariate dbs
# used_equations <- predictions %>% 
#   distinct(formula, .keep_all = TRUE) 

# 
# low_r <- predictions %>% 
#   distinct(R2, .keep_all = TRUE) %>% 
#   filter(R2 < 0.6) %>% 
#   select(Spp, Family, Genus, FunctionalGroup, pred_source, R2, AIC, formula)

# datatable(
#   low_r,
#   options = list(
#     pageLength = 20,        # show more rows per page
#     scrollX = TRUE,         # horizontal scrolling for wide tables
#     scrollY = "400px",      # limit vertical size
#     dom = "tip",            # minimal controls (t = table, i = info, p = pagination)
#     columnDefs = list(
#       list(className = 'dt-center', targets = "_all")  # center-align
#     )
#   ),
#   class = "compact stripe hover",
#   caption = "Low R-Squared"
# )


# zeros <- predictions %>% 
#  filter(Percent > 20 & pred_DryWeight == 0) %>% 
#   select(ID, Spp, Family, Genus, FunctionalGroup, pred_DryWeight, Percent,pred_source, R2, Formula)



# datatable(
#   zeros,
#   options = list(
#     pageLength = 20,        # show more rows per page
#     scrollX = TRUE,         # horizontal scrolling for wide tables
#     scrollY = "400px",      # limit vertical size
#     dom = "tip",            # minimal controls (t = table, i = info, p = pagination)
#     columnDefs = list(
#       list(className = 'dt-center', targets = "_all")  # center-align
#     )
#   ),
#   class = "compact stripe hover",
#   caption = "Flagged Predictions with Low Biomass"
# )
```

## Scatterplots of Predicted vs Observed Biomass

I went ahead and plotted each of the used equations to make sure I wasn't missing anything. The lists for each section highlight which equations have an R-squared value \<0.6. All of the graphs should contain the important information at the top.

### Species

```{r}
library(ggplot2)
library(dplyr)
library(purrr)
library(glue)
library(patchwork)

spp_pred_species <- predictions %>%
  filter(pred_source == "Spp") %>%
  pull(Spp) %>%
  unique()

# 2. Keep Spp predictions and matching Observed rows
spp_predictions_filtered <- predictions %>%
  filter(
    pred_source == "Spp" |
      (pred_source == "Observed" & Spp %in% spp_pred_species)
  )%>% 
  arrange(Spp)

plot_species_predictions <- function(species_name, predictions, save_plots = FALSE) {
  
  # Filter for this species
  dat <- predictions %>% filter(Spp == species_name)
  
  # Prepare annotation text
  formula_text <- unique(dat$Formula[dat$source_group == "Predicted"])
  r2_text <- unique(dat$R2[dat$source_group == "Predicted"])
  pred_source_text <- unique(dat$pred_source[dat$source_group == "Predicted"])
  
  annotation_text <- if (length(formula_text) > 0) {
    glue("Source: {pred_source_text}\n{formula_text}\nR² = {r2_text}")
  } else {
    ""
  }
  
  # Base theme
  base_theme <- theme_bw(base_size = 12) +
    theme(
      legend.title = element_blank(),
      plot.subtitle = element_text(size = 10, face = "italic")
    )
  
  # Plot 1: pred_DryWeight vs Percent
  p1 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
    geom_point(size = 2, alpha = 0.8) +
    labs(
      title = glue("{species_name} — Predicted Dry Weight"),
      subtitle = annotation_text,
      x = "Percent Cover",
      y = "Predicted Dry Weight (g)"
    ) +
    base_theme
  
  # Plot 2: pred_DryWeight vs ID
  p2 <- ggplot(dat, aes(x = ID, y = pred_DryWeight, color = source_group)) +
    geom_point(size = 2, alpha = 0.8) +
    labs(
      x = "Observation ID",
      y = "Predicted Dry Weight (g)"
    ) +
    base_theme
  
  # Combine plots side by side with legend at bottom
  combined_plot <- p1 + p2 + 
    plot_layout(guides = "collect") & 
    theme(legend.position = "bottom", legend.direction = "horizontal")
  
  # Save or display
  if (save_plots) {
    ggsave(glue("plots/{species_name}_pred_plot.png"), combined_plot, width = 10, height = 5, dpi = 300)
  } else {
    print(combined_plot)
  }
}



# Run for this subset
walk(unique(spp_predictions_filtered$Spp), ~plot_species_predictions(.x, spp_predictions_filtered))
```

### Genus

```{r}

genus_pred_species <- predictions %>%
  filter(pred_source == "Genus") %>%
  pull(Genus) %>%
  unique()

# 2. Keep Spp predictions and matching Observed rows
genus_predictions_filtered <- predictions %>%
  filter(
    pred_source == "Genus" |
      (pred_source == "Observed" & Genus %in% genus_pred_species)
  )%>% 
  arrange(Genus)

plot_genus_predictions <- function(genus_name, predictions, save_plots = FALSE) {
  
  # Filter for this species
  dat <- predictions %>% filter(Genus == genus_name)
  
  # Prepare annotation text
  formula_text <- unique(dat$Formula[dat$source_group == "Predicted"])
  r2_text <- unique(dat$R2[dat$source_group == "Predicted"])
  pred_source_text <- unique(dat$pred_source[dat$source_group == "Predicted"])
  
  annotation_text <- if (length(formula_text) > 0) {
    glue("Source: {pred_source_text}\n{formula_text}\nR² = {r2_text}")
  } else {
    ""
  }
  
  # Base theme
  base_theme <- theme_bw(base_size = 12) +
    theme(
      legend.title = element_blank(),
      plot.subtitle = element_text(size = 10, face = "italic")
    )
  
  # Plot 1: pred_DryWeight vs Percent
  p1 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
    geom_point(size = 2, alpha = 0.8) +
    labs(
      title = glue("{genus_name} — Predicted Dry Weight"),
      subtitle = annotation_text,
      x = "Percent Cover",
      y = "Predicted Dry Weight (g)"
    ) +
    base_theme
  
  # Plot 2: pred_DryWeight vs ID
  p2 <- ggplot(dat, aes(x = ID, y = pred_DryWeight, color = source_group)) +
    geom_point(size = 2, alpha = 0.8) +
    labs(
      x = "Observation ID",
      y = "Predicted Dry Weight (g)"
    ) +
    base_theme
  
  # Combine plots side by side with legend at bottom
  combined_plot <- p1 + p2 + 
    plot_layout(guides = "collect") & 
    theme(legend.position = "bottom", legend.direction = "horizontal")
  
  # Save or display
  if (save_plots) {
    ggsave(glue("plots/{genus_name}_pred_plot.png"), combined_plot, width = 10, height = 5, dpi = 300)
  } else {
    print(combined_plot)
  }
}


walk(unique(genus_predictions_filtered$Genus), ~plot_genus_predictions(.x, genus_predictions_filtered))
```

### Family

```{r}
fam_pred_species <- predictions %>%
  filter(pred_source == "Family") %>%
  pull(Family) %>%
  unique()

# 2. Keep Spp predictions and matching Observed rows
fam_predictions_filtered <- predictions %>%
  filter(
    pred_source == "Family" |
      (pred_source == "Observed" & Family %in% fam_pred_species)
  )%>% 
  arrange(Family)

plot_fam_predictions <- function(fam_name, predictions, save_plots = FALSE) {
  
  # Filter for this species
  dat <- predictions %>% filter(Family == fam_name)
  
  # Prepare annotation text
  formula_text <- unique(dat$Formula[dat$source_group == "Predicted"])
  r2_text <- unique(dat$R2[dat$source_group == "Predicted"])
  pred_source_text <- unique(dat$pred_source[dat$source_group == "Predicted"])
  
  annotation_text <- if (length(formula_text) > 0) {
    glue("Source: {pred_source_text}\n{formula_text}\nR² = {r2_text}")
  } else {
    ""
  }
  
  # Base theme
  base_theme <- theme_bw(base_size = 12) +
    theme(
      legend.title = element_blank(),
      plot.subtitle = element_text(size = 10, face = "italic")
    )
  
  # Plot 1: pred_DryWeight vs Percent
  p1 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
    geom_point(size = 2, alpha = 0.8) +
    labs(
      title = glue("{fam_name} — Predicted Dry Weight"),
      subtitle = annotation_text,
      x = "Percent Cover",
      y = "Predicted Dry Weight (g)"
    ) +
    base_theme
  
  # Plot 2: pred_DryWeight vs ID
  p2 <- ggplot(dat, aes(x = ID, y = pred_DryWeight, color = source_group)) +
    geom_point(size = 2, alpha = 0.8) +
    labs(
      x = "Observation ID",
      y = "Predicted Dry Weight (g)"
    ) +
    base_theme
  
  # Combine plots side by side with legend at bottom
  combined_plot <- p1 + p2 + 
    plot_layout(guides = "collect") & 
    theme(legend.position = "bottom", legend.direction = "horizontal")
  
  # Save or display
  if (save_plots) {
    ggsave(glue("plots/{fam_name}_pred_plot.png"), combined_plot, width = 10, height = 5, dpi = 300)
  } else {
    print(combined_plot)
  }
}


# Run for this subset
walk(unique(fam_predictions_filtered$Family), ~plot_fam_predictions(.x, fam_predictions_filtered))
```

### Functional Group

```{r}
#|warning: False
#|Message: False

fg_pred_species <- predictions %>%
  filter(pred_source == "FunctionalGroup") %>%
  pull(FunctionalGroup) %>%
  unique()

# 2. Keep Spp predictions and matching Observed rows
fg_predictions_filtered <- predictions %>%
  filter(
    pred_source == "FunctionalGroup" |
      (pred_source == "Observed" & FunctionalGroup %in% fg_pred_species)
  )%>% 
  arrange(FunctionalGroup)

plot_fg_predictions <- function(fg_name, predictions, save_plots = FALSE) {
  
  # Filter for this species
  dat <- predictions %>% filter(FunctionalGroup == fg_name)
  
  # Prepare annotation text
  formula_text <- unique(dat$Formula[dat$source_group == "Predicted"])
  r2_text <- unique(dat$R2[dat$source_group == "Predicted"])
  pred_source_text <- unique(dat$pred_source[dat$source_group == "Predicted"])
  
  annotation_text <- if (length(formula_text) > 0) {
    glue("Source: {pred_source_text}\n{formula_text}\nR² = {r2_text}")
  } else {
    ""
  }
  
  # Base theme
  base_theme <- theme_bw(base_size = 12) +
    theme(
      legend.title = element_blank(),
      plot.subtitle = element_text(size = 10, face = "italic")
    )
  
  # Plot 1: pred_DryWeight vs Percent
  p1 <- ggplot(dat, aes(x = Percent, y = pred_DryWeight, color = source_group)) +
    geom_point(size = 2, alpha = 0.8) +
    labs(
      title = glue("{fg_name} — Predicted Dry Weight"),
      subtitle = annotation_text,
      x = "Percent Cover",
      y = "Predicted Dry Weight (g)"
    ) +
    base_theme
  
  # Plot 2: pred_DryWeight vs ID
  p2 <- ggplot(dat, aes(x = ID, y = pred_DryWeight, color = source_group)) +
    geom_point(size = 2, alpha = 0.8) +
    labs(
      x = "Observation ID",
      y = "Predicted Dry Weight (g)"
    ) +
    base_theme
  
  # Combine plots side by side with legend at bottom
  combined_plot <- p1 + p2 + 
    plot_layout(guides = "collect") & 
    theme(legend.position = "bottom", legend.direction = "horizontal")
  
  # Save or display
  if (save_plots) {
    ggsave(glue("plots/{fg_name}_pred_plot.png"), combined_plot, width = 10, height = 5, dpi = 300)
  } else {
    print(combined_plot)
  }
}

# Run for this subset
walk(unique(fg_predictions_filtered$FunctionalGroup), ~plot_fg_predictions(.x, fg_predictions_filtered))
```

```{r}
#Species Level Regression Coefficients 
#| warning: FALSE
# 
# used_spp_predictions <- used_equations %>% 
#   filter(pred_source == "Spp") %>%  
#   select(Spp, R2, Formula) %>%
#   left_join(spp_predictions, by = "R2") %>% 
#   select(-Spp.y) %>% 
#   rename(Spp = Spp.x) %>% 
#   mutate(across(where(is.numeric), ~ round(.x, 4)))


# datatable(
#   used_spp_predictions,
#   options = list(
#     pageLength = 20,        # show more rows per page
#     scrollX = TRUE,         # horizontal scrolling for wide tables
#     scrollY = "400px",      # limit vertical size
#     dom = "tip",            # minimal controls (t = table, i = info, p = pagination)
#     columnDefs = list(
#       list(className = 'dt-center', targets = "_all")  # center-align
#     )
#   ),
#   class = "compact stripe hover",
#   caption = "Species Coefficients"
# )


# #Genus Level Regression Coefficients 
# used_genus_predictions <- used_equations %>% 
#   filter(pred_source == "Genus") %>% 
#   select(Genus, R2, Formula) %>% 
#   left_join(genus_predictions, by = "R2") %>% 
#   select(-Spp) %>% 
#     mutate(across(where(is.numeric), ~ round(.x, 4)))

# datatable(
#   used_genus_predictions,
#   options = list(
#     pageLength = 20,        # show more rows per page
#     scrollX = TRUE,         # horizontal scrolling for wide tables
#     scrollY = "400px",      # limit vertical size
#     dom = "tip",            # minimal controls (t = table, i = info, p = pagination)
#     columnDefs = list(
#       list(className = 'dt-center', targets = "_all")  # center-align
#     )
#   ),
#   class = "compact stripe hover",
#   caption = "Genus Coefficients"
# )


# #Family Level Regression Coefficients 
# used_fam_predictions <- used_equations %>% 
#   filter(pred_source == "Family") %>% 
#   select(Family, R2, Formula) %>% 
#   left_join(fam_predictions, by = "R2") %>% 
#   select(-Spp) %>% 
#     mutate(across(where(is.numeric), ~ round(.x, 4)))

# datatable(
#   used_fam_predictions,
#   options = list(
#     pageLength = 20,        # show more rows per page
#     scrollX = TRUE,         # horizontal scrolling for wide tables
#     scrollY = "400px",      # limit vertical size
#     dom = "tip",            # minimal controls (t = table, i = info, p = pagination)
#     columnDefs = list(
#       list(className = 'dt-center', targets = "_all")  # center-align
#     )
#   ),
#   class = "compact stripe hover",
#   caption = "Familu Coefficients"
# )


# #FG Level Regression Coefficients 
# used_fg_predictions <- used_equations %>% 
#   filter(pred_source == "FunctionalGroup") %>% 
#   select(FunctionalGroup, R2, Formula) %>% 
#   left_join(fg_predictions, by = "R2") %>% 
#   select(-Spp) %>% 
#     mutate(across(where(is.numeric), ~ round(.x, 4)))

# datatable(
#   used_fg_predictions,
#   options = list(
#     pageLength = 20,        # show more rows per page
#     scrollX = TRUE,         # horizontal scrolling for wide tables
#     scrollY = "400px",      # limit vertical size
#     dom = "tip",            # minimal controls (t = table, i = info, p = pagination)
#     columnDefs = list(
#       list(className = 'dt-center', targets = "_all")  # center-align
#     )
#   ),
#   class = "compact stripe hover",
#   caption = "Functional Group Coefficients"
# )
```
